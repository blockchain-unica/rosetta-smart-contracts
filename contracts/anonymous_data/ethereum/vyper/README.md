# Anonymous data in Vyper

## State Variables

- `MAX_DATASIZE: constant(uint256) = 100` — the maximum length of the dynamic bytes array of `userData`
- `userData: HashMap[bytes32, Bytes[MAX_DATASIZE]]` — stores each user's data as bytes.

> **Note:**  
> Dynamic arrays in Vyper require specifying a maximum length.  
> The **userData** variable allows up to 100 bytes, which is relatively small, but sufficient for this example.

## Initialization

```py
@deploy
def __init__():
    pass
```

The deployment function has no purpose other than deploying the contract on-chain.
The state variable **userData** is automatically initialized with an empty value at compile time, as is the case for all variable types in Vyper.

Therefore, the **__init__** function simply uses the **pass** keyword to indicate that it does not perform any explicit state initialization.

## calculateID

```py
@view
@internal
def calculateID(_addr: address, _nonce: uint256) -> bytes32:
    return keccak256(
        concat(
            convert(_addr, bytes20),
            convert(_nonce, bytes32)
        )
    )
```
**calculateID** is a helper function and the only one tagged **@internal**. Internal functions in Vyper, can only be called from within the contract, and because the function is also tagged as **@view**, it cannot change the state of the contract but only read it.

It takes in two parameters:
- `_addr: address` — the address of the user calling the **getID** function (`msg.sender`).
- `_nonce: uint256` — a nonce (number used once) chosen by the user to generate a unique ID.

It converts the inputs into fixed-size byte sequences, concatenates them, and then computes the **keccak256** hash of the result.

The return value is a fixed-size 32-byte array representing the hash of the combined address and nonce.

## getID

```py
@view 
@external
def getID(_nonce: uint256) -> bytes32:
    return self.calculateID(msg.sender, _nonce)
```

The **getID** function is also a **@view** function and simply forwards the value returned by the **calculateID**.

## storeData

```py
@external
def storeData(_userID: bytes32, _data: Bytes[MAX_DATASIZE]):
    assert len(_data) != 0, "0 bytes of data sent"
    assert self.usersData[_userID] == empty(Bytes[MAX_DATASIZE]), "Contract already stores data for this ID"

    self.usersData[_userID] = _data
```

This function takes two parameters:
- `_userID: bytes32` — the unique identifier for the user, generated by the **calculateID** function.  
- `_data: Bytes[MAX_DATASIZE]` — the data to be stored, limited to 100 bytes.

The function behaviour is as follow:
1. It checks that **_data** is not empty.  
2. It ensures that no existing data is already stored for the given **_userID**.  
3. If both conditions are met, the data is saved in the **usersData** mapping under the corresponding ID.

## getMyData

```py
@view 
@external
def getMyData(_nonce: uint256) -> Bytes[MAX_DATASIZE]:
    id: bytes32 = self.calculateID(msg.sender, _nonce)
    return self.usersData[id]
```

This function takes a single parameter:
- `_nonce: uint256` — used to regenerate the user ID.

The implementation is straightforward:
- The function recalculates the ID using the given nonce.  
- If data exists for that ID, it returns the user’s stored data.  
- Otherwise, it reverts with an error indicating that no data is associated with the specified ID.

## Differences between the Vyper and Solidity implementations
- ID generation
    - Solidity uses the built-in function `abi.encode()` — which allows to input more than one parameter — to produce the ABI-encoded bytes of `msg.sender` +      `nonce` to be used for hashing. Vyper does not support `abi.encode`, so the Vyper contract manually encodes the address and nonce using `convert(...)` + `concat(...)`. This required introducing the helper function `calculateID`.
- Ownership logic not implemented (there isn't a `getAllData` method)
- Vyper implementation does not allow overwriting stored data. 
- Vyper only allows dynamic arrays with fixed capacity, imposing an explicit maximum data length (100 bytes used as an example).





